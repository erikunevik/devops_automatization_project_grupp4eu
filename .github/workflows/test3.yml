name: test3 #prov

on:
  
  
  workflow_dispatch:
    inputs:
      logg-error-generator:
        description: "Do you want to generate a logg-error artefact (true/false)"
        default: "false"
        type: choice 
        options: ["true", "false"]

jobs:
  testing:
    runs-on: ubuntu-latest

    steps:
      - name: Gets the whole repo
        uses: actions/checkout@v4
        
      - name: Installs latest version of python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run unit test false
        if: ${{ github.event.inputs.logg-error-generator == 'false'
        run:  pytest -q weather_app/pytests/test_city_coordinates.py

      - name: Run unit test true
        if: ${{ github.event.inputs.logg-error-generator == 'true'
        shell: bash
        run: pytest -q weather_app/pytests/test_city_coordinates.py > logs.txt
        
      - name: Run integration test false
        if: ${{ github.event.inputs.logg-error-generator == 'false'
        run: pytest -q weather_app/pytests/test_api_call.py

      - name: Run integration test true
        if: ${{ github.event.inputs.logg-error-generator == 'true'
        shell: bash
        run: pytest -q weather_app/pytests/test_api_call.py > logs.txt
        
      - name: upload-error-artifact
        if: failure() && github.event.inputs.logg-error-generator == 'true'
        uses: actions/upload-artifact@v4
        with:
            name: failed-test-log
            path: logs.txt



  building-docker-image:
    needs: testing
    runs-on: ubuntu-latest
    
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push to Docker Hub
        uses: docker/build-push-action@v6
        with:
          context: .
          file: dockerfile
          push: true
          tags: |
            studenteriksti/devops-pipeline_grupp4_eu:latest
            studenteriksti/devops-pipeline_grupp4_eu:1.5

      - name: Confirm image pushed
        if: success()
        run: echo "✅ Image successfully built and pushed"

      - name: Report failure
        if: failure()
        run: echo "❌ Docker image build or pushed failed"
